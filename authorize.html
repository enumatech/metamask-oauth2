<html>
<head>
    <title>Metamask OAuth2 provider</title>
    <script src="https://wallet.metamask.io/metamascara.js"></script>
</head>
<body>
    <h1>Metamask OAuth2 provider</h1>
    <div id="target"></div>
    <button id="sign">Sign with metamask</button>
    <script type="text/javascript" src="query.js"></script>
    <script type="text/javascript">

const global = {};

function rpc(str, callback, ...params) {
    return global.web3.currentProvider.sendAsync({
        method: str,
        params: params,
    }, function (err, result) {
        if (err) return callback(err);
        if (result.error) {
            return callback(result.error);
        }
        return callback(null, result.result);
    });
}

function eth_accounts(callback) {
    return rpc("eth_accounts", callback);
}

function eth_sign(str, from, callback) {
    return rpc('eth_sign', callback, from, str);
}

function personal_sign(str, from, callback) {
    return rpc('personal_sign', callback, from, str);
}

function eth_signTypedData(msgParams, from, callback) {
    return rpc('eth_signTypedData', callback, msgParams, from);
}

function render(str) {
    document.getElementById("target").innerText = str;
}

function startApp(){

    // check environment
    if (!global.web3) {
        // start mascara
        const provider = metamask.createDefaultProvider({});
        global.web3 = { currentProvider: provider };
    }

    var obj = parseQuery(window.location.search + window.location.hash);

    // Detect our own errors
    if (obj.error) {
        render(obj.error_description || obj.error);
    }

    function error(err, desc) {
        window.location = (obj.redirect_uri || "") + "#" + makeQuery({
            error: err,
            error_description: desc,
            state: obj.state
        });
    }

    if (window.location.protocol !== "https:" && window.location.host !== "localhost") {
        return error("unsupported_over_http");
    }
    if (!obj.redirect_uri) {
        return error("parameter_absent", "Missing: redirect_uri");
    }
    if (!obj.response_type) {
        return error("parameter_absent", "Missing: response_type");
    }
    if (obj.response_type !== "token") {
        return error("unsupported_response_type", "Unsupported response types: " + obj.response_type);
    }
    if (!obj.client_id) {
        return error("parameter_absent", "Missing: client_id");
    }
    if (obj.scope) {
        return error("invalid_scope", "Unsupported scopes: " + obj.scope);
    }
    if (obj.client_id !== "self") {
        return error("unauthorized_client");
    }
    if (obj.redirect_uri.indexOf(window.location.host) < 0) {
        return error("invalid_callback");
    }

    render(window.location.host + " requests authorization.");

    function fromHex(hex) {
        return hex.match(/\w{2}/g).map(function(a){return String.fromCharCode(parseInt(a, 16));} ).join("");
    }

    function toBase64url(bytes) {
        return btoa(bytes).replace(/=/,'').replace(/\//,'_').replace(/\+/,'-');
    }

    function sign(e) {
        eth_accounts(function (err, accounts) {
            if (!accounts) {
                return error("unauthorized_client", "No accounts found");
            }

            const iss = "https://" + window.location.host + window.location.pathname;
            const now = Math.floor(new Date().getTime()/1000);
            const expires_in = 60;

            const jose = {alg: "ES256K", typ: "JWT"};
            const claims = {iss: iss, sub: accounts[0], iat: now, nbf: now, aud: obj.client_id, exp: now+expires_in, nonce: obj.nonce };
            const jwt = JSON.stringify(jose) + "." + JSON.stringify(claims,null,2);

            personal_sign(jwt, accounts[0], function(err, sighex) {

                if (err) {
                    return error("access_denied", err.message || err);
                }

                const sig = toBase64url(fromHex(sighex.substr(2,128)));

                window.location = obj.redirect_uri + "#" + makeQuery({
                    access_token: jwt + "." + sig,
                    token_type: "bearer",
                    expires_in: expires_in,
                    //scope: obj.scope,
                    state: obj.state,
                });
            });
        });
    }

    document.getElementById("sign").addEventListener("click", sign);
}

window.addEventListener("load", startApp);
    </script>
</body>
</html>
